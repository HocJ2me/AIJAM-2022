define("discourse/plugins/poll/components/poll-breakdown-chart",["exports","@ember/component","I18n","discourse/plugins/poll/controllers/poll-ui-builder","discourse-common/utils/decorators","discourse/plugins/poll/lib/chart-colors","@ember/template","@ember/object/computed","@ember/runloop"],(function(t,e,l,o,n,i,r,a,s){"use strict";var u,p,c;function d(t,e,l,o,n){var i={};return Object.keys(o).forEach((function(t){i[t]=o[t]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=l.slice().reverse().reduce((function(l,o){return o(t,e,l)||l}),i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(t,e,i),i=null),i}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var h=e.default.extend((u=(0,n.default)("optionColors","index"),p=(0,n.default)("data","displayMode"),c={group:null,options:null,displayMode:null,highlightedOption:null,setHighlightedOption:null,classNames:"poll-breakdown-chart-container",_optionToSlice:null,_previousHighlightedSliceIndex:null,_previousDisplayMode:null,data:(0,a.mapBy)("options","votes"),init:function(){this._super.apply(this,arguments),this._optionToSlice={}},didInsertElement:function(){this._super.apply(this,arguments);var t=this.element.querySelector("canvas");this._chart=new window.Chart(t.getContext("2d"),this.chartConfig)},didReceiveAttrs:function(){this._super.apply(this,arguments),this._chart&&(this._updateDisplayMode(),this._updateHighlight())},willDestroy:function(){this._super.apply(this,arguments),this._chart&&this._chart.destroy()},colorStyle:function(t,e){return(0,r.htmlSafe)("background: ".concat(t[e],";"))},chartConfig:function(t,e){var n=this,r=[],a=0;this._optionToSlice={},t.forEach((function(t,e){t>0&&(r.push(t),n._optionToSlice[e]=a++)}));var u=r.reduce((function(t,e){return t+e}),0),p=(0,i.getColors)(t.length).filter((function(e,l){return t[l]>0}));return{type:o.PIE_CHART_TYPE,plugins:[window.ChartDataLabels],data:{datasets:[{data:r,backgroundColor:p,hoverBorderColor:"#fff"}]},options:{plugins:{tooltip:!1,datalabels:{color:"#333",backgroundColor:"rgba(255, 255, 255, 0.5)",borderRadius:2,font:{family:getComputedStyle(document.body).fontFamily,size:16},padding:{top:2,right:6,bottom:2,left:6},formatter:function(t){if("percentage"!==e)return t;var o=l.default.toNumber(t/u*100,{precision:1});return"".concat(o,"%")}}},responsive:!0,aspectRatio:1.1,animation:{duration:0},onHover:function(t,e){if(e.length){var l=e[0]._index,o=Object.keys(n._optionToSlice).find((function(t){return n._optionToSlice[t]===l}));e.length=0,(0,s.next)((function(){n.setHighlightedOption(Number(o))}))}else(0,s.next)((function(){n.setHighlightedOption(null)}))}}}},_updateDisplayMode:function(){if(this.displayMode!==this._previousDisplayMode){var t=this.chartConfig;this._chart.data.datasets=t.data.datasets,this._chart.options=t.options,this._chart.update(),this._previousDisplayMode=this.displayMode}},_updateHighlight:function(){var t=this._chart.getDatasetMeta(0);if(null!==this._previousHighlightedSliceIndex){var e=t.data[this._previousHighlightedSliceIndex];t.controller.removeHoverStyle(e),this._chart.draw()}if(null!==this.highlightedOption){var l=this._optionToSlice[this.highlightedOption];if(void 0!==l){var o=t.data[l];this._previousHighlightedSliceIndex=l,t.controller.setHoverStyle(o),this._chart.draw()}else this._previousHighlightedSliceIndex=null}else this._previousHighlightedSliceIndex=null}},d(c,"colorStyle",[u],Object.getOwnPropertyDescriptor(c,"colorStyle"),c),d(c,"chartConfig",[p],Object.getOwnPropertyDescriptor(c,"chartConfig"),c),c));t.default=h})),define("discourse/plugins/poll/components/poll-breakdown-option",["exports","@ember/component","I18n","@ember/object","discourse-common/utils/decorators","@ember/object/computed","discourse/plugins/poll/lib/chart-colors","@ember/template","discourse/lib/computed"],(function(t,e,l,o,n,i,r,a,s){"use strict";var u,p,c,d,h;function f(t,e,l,o,n){var i={};return Object.keys(o).forEach((function(t){i[t]=o[t]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=l.slice().reverse().reduce((function(l,o){return o(t,e,l)||l}),i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(t,e,i),i=null),i}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var b=e.default.extend((u=(0,n.default)("option.votes","totalVotes"),p=(0,n.default)("optionsCount"),c=(0,n.default)("highlighted"),d=(0,n.default)("highlighted","optionColors","index"),f(h={option:null,index:null,totalVotes:null,optionsCount:null,displayMode:null,highlightedOption:null,onMouseOver:null,onMouseOut:null,tagName:"",highlighted:(0,s.propertyEqual)("highlightedOption","index"),showPercentage:(0,i.equal)("displayMode","percentage"),percent:function(t,e){return l.default.toNumber(t/e*100,{precision:1})},optionColors:function(t){return(0,r.getColors)(t)},colorBackgroundStyle:function(t){if(t)return(0,a.htmlSafe)("background: rgba(0, 0, 0, 0.1);")},colorPreviewStyle:function(t,e,l){var o=t?window.Chart.helpers.getHoverColor(e[l]):e[l];return(0,a.htmlSafe)("background: ".concat(o,";"))},onHover:function(t){t?this.onMouseOver():this.onMouseOut()}},"percent",[u],Object.getOwnPropertyDescriptor(h,"percent"),h),f(h,"optionColors",[p],Object.getOwnPropertyDescriptor(h,"optionColors"),h),f(h,"colorBackgroundStyle",[c],Object.getOwnPropertyDescriptor(h,"colorBackgroundStyle"),h),f(h,"colorPreviewStyle",[d],Object.getOwnPropertyDescriptor(h,"colorPreviewStyle"),h),f(h,"onHover",[o.action],Object.getOwnPropertyDescriptor(h,"onHover"),h),h));t.default=b})),define("discourse/plugins/poll/controllers/poll-breakdown",["exports","@ember/controller","I18n","discourse/mixins/modal-functionality","@ember/object","discourse/lib/ajax","@ember/string","discourse-common/utils/decorators","@ember/template","discourse/lib/load-script","discourse/lib/ajax-error","bootbox"],(function(t,e,l,o,n,i,r,a,s,u,p,c){"use strict";var d,h,f,b;function m(t,e,l,o,n){var i={};return Object.keys(o).forEach((function(t){i[t]=o[t]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=l.slice().reverse().reduce((function(l,o){return o(t,e,l)||l}),i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(t,e,i),i=null),i}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var v=e.default.extend(o.default,(d=(0,a.default)("model.poll.title","model.post.topic.title"),h=(0,a.default)("model.groupableUserFields"),f=(0,a.default)("model.poll.options"),m(b={model:null,charts:null,groupedBy:null,highlightedOption:null,displayMode:"percentage",title:function(t,e){return t?(0,s.htmlSafe)(t):e},groupableUserFields:function(t){return t.map((function(t){var e=t.split("_").filter(Boolean);return e.length>1&&(e[0]=(0,r.classify)(e[0])),{id:t,label:e.join(" ")}}))},totalVotes:function(t){return t.reduce((function(t,e){return t+e.votes}),0)},onShow:function(){var t=this;this.set("charts",null),this.set("displayMode","percentage"),this.set("groupedBy",this.model.groupableUserFields[0]),(0,u.default)("/javascripts/Chart.min.js").then((function(){return(0,u.default)("/javascripts/chartjs-plugin-datalabels.min.js")})).then((function(){t.fetchGroupedPollData()}))},fetchGroupedPollData:function(){var t=this;return(0,i.ajax)("/polls/grouped_poll_results.json",{data:{post_id:this.model.post.id,poll_name:this.model.poll.name,user_field_name:this.groupedBy}}).catch((function(t){t?(0,p.popupAjaxError)(t):c.default.alert(l.default.t("poll.error_while_fetching_voters"))})).then((function(e){t.isDestroying||t.isDestroyed||t.set("charts",e.grouped_results)}))},setGrouping:function(t){this.set("groupedBy",t),this.fetchGroupedPollData()},onSelectPanel:function(t){this.set("displayMode",t.id)}},"title",[d],Object.getOwnPropertyDescriptor(b,"title"),b),m(b,"groupableUserFields",[h],Object.getOwnPropertyDescriptor(b,"groupableUserFields"),b),m(b,"totalVotes",[f],Object.getOwnPropertyDescriptor(b,"totalVotes"),b),m(b,"setGrouping",[n.action],Object.getOwnPropertyDescriptor(b,"setGrouping"),b),m(b,"onSelectPanel",[n.action],Object.getOwnPropertyDescriptor(b,"onSelectPanel"),b),b));t.default=v})),define("discourse/plugins/poll/controllers/poll-ui-builder",["exports","@ember/controller","@ember/object","@ember/object/computed","@ember/runloop","discourse-common/utils/decorators","discourse/mixins/modal-functionality","I18n"],(function(t,e,l,o,n,i,r,a){"use strict";var s,u,p,c,d,h,f,b,m,v,g,_,y;function O(t){return function(t){if(Array.isArray(t))return w(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return w(t,e);var l=Object.prototype.toString.call(t).slice(8,-1);"Object"===l&&t.constructor&&(l=t.constructor.name);if("Map"===l||"Set"===l)return Array.from(t);if("Arguments"===l||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l))return w(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(t,e){(null==e||e>t.length)&&(e=t.length);for(var l=0,o=new Array(e);l<e;l++)o[l]=t[l];return o}function x(t,e,l,o,n){var i={};return Object.keys(o).forEach((function(t){i[t]=o[t]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=l.slice().reverse().reduce((function(l,o){return o(t,e,l)||l}),i),n&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(n):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(t,e,i),i=null),i}Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.REGULAR_POLL_TYPE=t.PIE_CHART_TYPE=t.NUMBER_POLL_TYPE=t.MULTIPLE_POLL_TYPE=t.BAR_CHART_TYPE=void 0;var M="bar";t.BAR_CHART_TYPE=M;t.PIE_CHART_TYPE="pie";var P="regular";t.REGULAR_POLL_TYPE=P;var j="number";t.NUMBER_POLL_TYPE=j;var C="multiple";t.MULTIPLE_POLL_TYPE=C;var k="always",S=e.default.extend(r.default,(s=(0,i.default)("pollType"),u=(0,i.default)("pollType"),p=(0,i.default)("pollType"),c=(0,i.default)("pollOptions.@each.value"),d=(0,i.default)("site.groups"),h=(0,i.default)("chartType","pollType"),f=(0,i.observes)("pollType","pollOptionsCount"),b=(0,i.default)("pollType","pollResult","publicPoll","pollTitle","pollOptions.@each.value","pollMin","pollMax","pollStep","pollGroups","pollAutoClose","chartType"),m=(0,i.default)("isNumber","pollOptionsCount"),v=(0,i.default)("pollOptions.@each.value"),g=(0,i.default)("isMultiple","pollOptionsCount","isNumber","pollMin","pollMax","pollStep"),_=(0,i.default)("minMaxValueValidation","minNumOfOptionsValidation"),x(y={showAdvanced:!1,pollType:P,pollTitle:"",pollOptions:null,pollOptionsText:null,pollMin:1,pollMax:2,pollStep:1,pollGroups:null,pollAutoClose:null,pollResult:k,chartType:M,publicPoll:null,onShow:function(){this.setProperties({showAdvanced:!1,pollType:P,pollTitle:null,pollOptions:[l.default.create({value:""})],pollOptionsText:"",pollMin:1,pollMax:2,pollStep:1,pollGroups:null,pollAutoClose:null,pollResult:k,chartType:M,publicPoll:!1})},pollResults:function(){var t=[{name:a.default.t("poll.ui_builder.poll_result.always"),value:k},{name:a.default.t("poll.ui_builder.poll_result.vote"),value:"on_vote"},{name:a.default.t("poll.ui_builder.poll_result.closed"),value:"on_close"}];return this.get("currentUser.staff")&&t.push({name:a.default.t("poll.ui_builder.poll_result.staff"),value:"staff_only"}),t},isRegular:function(t){return t===P},isNumber:function(t){return t===j},isMultiple:function(t){return t===C},showNumber:(0,o.or)("showAdvanced","isNumber"),pollOptionsCount:function(t){return(t||[]).filter((function(t){return t.value.length>0})).length},siteGroups:function(t){return t.filter((function(t){return 0!==t.id}))},isPie:function(t,e){return e!==j&&"pie"===t},canRemoveOption:(0,o.gt)("pollOptions.length",1),_setPollMinMax:function(){this.isMultiple?((this.pollMin<=0||this.pollMin>=this.pollMax||this.pollMin>=this.pollOptionsCount)&&this.set("pollMin",this.pollOptionsCount>0?1:0),(this.pollMax<=0||this.pollMin>=this.pollMax||this.pollMax>this.pollOptionsCount)&&this.set("pollMax",this.pollOptionsCount)):this.isNumber&&this.set("pollMax",this.siteSettings.poll_maximum_options)},pollOutput:function(t,e,l,o,n,i,r,a,s,u,p){var c="[poll",d="",h=this.toolbarEvent.getText().match(/\[poll(\s+name=[^\s\]]+)*.*\]/gim);h&&(c+=" name=poll".concat(h.length+1));var f=a;return f<1&&(f=1),t&&(c+=" type=".concat(t)),e&&(c+=" results=".concat(e)),i&&t!==P&&(c+=" min=".concat(i)),r&&t!==P&&(c+=" max=".concat(r)),t===j&&(c+=" step=".concat(f)),l&&(c+=" public=true"),p&&t!==j&&(c+=" chartType=".concat(p)),s&&s.length>0&&(c+=" groups=".concat(s)),u&&(c+=" close=".concat(u.toISOString())),d+="".concat(c+="]","\n"),o&&(d+="# ".concat(o.trim(),"\n")),n.length>0&&t!==j&&n.forEach((function(t){t.value.length>0&&(d+="* ".concat(t.value.trim(),"\n"))})),d+="[/poll]\n"},minNumOfOptionsValidation:function(t,e){if(!t){if(e<1)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.options_min_count")});if(e>this.siteSettings.poll_maximum_options)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.options_max_count",{count:this.siteSettings.poll_maximum_options})})}return l.default.create({ok:!0})},showMinNumOfOptionsValidation:function(t){return 1!==t.length||""!==t[0].value},minMaxValueValidation:function(t,e,o,n,i,r){if(n=parseInt(n,10)||0,i=parseInt(i,10)||0,r=parseInt(r,10)||0,n<0)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.invalid_min_value")});if(i<0||t&&i>e)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.invalid_max_value")});if(n>i)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.invalid_values")});if(o){if(r<1)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.min_step_value")});var s=(i-n+1)/r;if(s<1)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.options_min_count")});if(s>this.siteSettings.poll_maximum_options)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.options_max_count",{count:this.siteSettings.poll_maximum_options})})}return l.default.create({ok:!0})},disableInsert:function(t,e){return!t.ok||!e.ok},_comboboxOptions:function(t,e){return O(Array(e-t).keys()).map((function(e){return{value:e+t,name:e+t}}))},onOptionsTextChange:function(t){var e=0;this.set("pollOptions",t.target.value.split("\n").map((function(t){return l.default.create({idx:e++,value:t})})))},insertPoll:function(){this.toolbarEvent.addText(this.pollOutput),this.send("closeModal")},toggleAdvanced:function(){this.toggleProperty("showAdvanced"),this.showAdvanced&&this.set("pollOptionsText",this.pollOptions.map((function(t){return t.value})).join("\n"))},addOption:function(t,e,o){if(""!==e){var i=this.pollOptions.indexOf(t)+1,r=l.default.create({value:""});this.pollOptions.insertAt(i,r);var a=0;this.pollOptions.forEach((function(t){return t.set("idx",a++)})),(0,n.next)((function(){var t=document.getElementsByClassName("poll-options");if(t){var e=t[0].getElementsByTagName("input");r.idx<e.length&&e[r.idx].focus()}}))}o&&o.preventDefault()},removeOption:function(t){this.pollOptions.removeObject(t)}},"pollResults",[i.default],Object.getOwnPropertyDescriptor(y,"pollResults"),y),x(y,"isRegular",[s],Object.getOwnPropertyDescriptor(y,"isRegular"),y),x(y,"isNumber",[u],Object.getOwnPropertyDescriptor(y,"isNumber"),y),x(y,"isMultiple",[p],Object.getOwnPropertyDescriptor(y,"isMultiple"),y),x(y,"pollOptionsCount",[c],Object.getOwnPropertyDescriptor(y,"pollOptionsCount"),y),x(y,"siteGroups",[d],Object.getOwnPropertyDescriptor(y,"siteGroups"),y),x(y,"isPie",[h],Object.getOwnPropertyDescriptor(y,"isPie"),y),x(y,"_setPollMinMax",[f],Object.getOwnPropertyDescriptor(y,"_setPollMinMax"),y),x(y,"pollOutput",[b],Object.getOwnPropertyDescriptor(y,"pollOutput"),y),x(y,"minNumOfOptionsValidation",[m],Object.getOwnPropertyDescriptor(y,"minNumOfOptionsValidation"),y),x(y,"showMinNumOfOptionsValidation",[v],Object.getOwnPropertyDescriptor(y,"showMinNumOfOptionsValidation"),y),x(y,"minMaxValueValidation",[g],Object.getOwnPropertyDescriptor(y,"minMaxValueValidation"),y),x(y,"disableInsert",[_],Object.getOwnPropertyDescriptor(y,"disableInsert"),y),x(y,"onOptionsTextChange",[l.action],Object.getOwnPropertyDescriptor(y,"onOptionsTextChange"),y),x(y,"insertPoll",[l.action],Object.getOwnPropertyDescriptor(y,"insertPoll"),y),x(y,"toggleAdvanced",[l.action],Object.getOwnPropertyDescriptor(y,"toggleAdvanced"),y),x(y,"addOption",[l.action],Object.getOwnPropertyDescriptor(y,"addOption"),y),x(y,"removeOption",[l.action],Object.getOwnPropertyDescriptor(y,"removeOption"),y),y));t.default=S})),Ember.TEMPLATES["javascripts/components/poll-breakdown-chart"]=Ember.HTMLBars.template({id:null,block:'[[[10,"label"],[14,0,"poll-breakdown-chart-label"],[12],[1,[30,1]],[13],[1,"\\n"],[10,"canvas"],[14,0,"poll-breakdown-chart-chart"],[12],[13],[1,"\\n"]],["@group"],false,[]]',moduleName:"javascripts/discourse/templates/components/poll-breakdown-chart",isStrictMode:!1}),Ember.TEMPLATES["javascripts/components/poll-breakdown-option"]=Ember.HTMLBars.template({id:null,block:'[[[11,"li"],[24,0,"poll-breakdown-option"],[16,5,[30,0,["colorBackgroundStyle"]]],[24,"role","button"],[4,[38,0],["mouseover",[30,1]],null],[4,[38,0],["mouseout",[30,2]],null],[12],[1,"\\n  "],[10,1],[14,0,"poll-breakdown-option-color"],[15,5,[30,0,["colorPreviewStyle"]]],[12],[13],[1,"\\n\\n  "],[10,1],[14,0,"poll-breakdown-option-count"],[12],[1,"\\n"],[41,[30,0,["showPercentage"]],[[[1,"      "],[1,[30,0,["percent"]]],[1,"%\\n"]],[]],[[[1,"      "],[1,[30,3,["votes"]]],[1,"\\n"]],[]]],[1,"  "],[13],[1,"\\n  "],[10,1],[14,0,"poll-breakdown-option-text"],[12],[1,[28,[35,2],[[30,3,["html"]]],null]],[13],[1,"\\n"],[13],[1,"\\n"]],["@onMouseOver","@onMouseOut","@option"],false,["on","if","html-safe"]]',moduleName:"javascripts/discourse/templates/components/poll-breakdown-option",isStrictMode:!1}),Ember.TEMPLATES["javascripts/modal/poll-breakdown"]=Ember.HTMLBars.template({id:null,block:'[[[8,[39,0],null,[["@title"],["poll.breakdown.title"]],[["default"],[[[[1,"\\n  "],[10,0],[14,0,"poll-breakdown-sidebar"],[12],[1,"\\n    "],[10,2],[14,0,"poll-breakdown-title"],[12],[1,"\\n      "],[1,[30,0,["title"]]],[1,"\\n    "],[13],[1,"\\n\\n    "],[10,0],[14,0,"poll-breakdown-total-votes"],[12],[1,[28,[35,1],["poll.breakdown.votes"],[["count"],[[30,0,["model","poll","voters"]]]]]],[13],[1,"\\n\\n    "],[10,"ul"],[14,0,"poll-breakdown-options"],[12],[1,"\\n"],[42,[28,[37,3],[[28,[37,3],[[30,0,["model","poll","options"]]],null]],null],null,[[[1,"        "],[8,[39,4],null,[["@option","@index","@totalVotes","@optionsCount","@displayMode","@highlightedOption","@onMouseOver","@onMouseOut"],[[30,1],[30,2],[30,0,["totalVotes"]],[30,0,["model","poll","options","length"]],[30,0,["displayMode"]],[30,0,["highlightedOption"]],[28,[37,5],[[28,[37,6],[[30,0,["highlightedOption"]]],null],[30,2]],null],[28,[37,5],[[28,[37,6],[[30,0,["highlightedOption"]]],null],null],null]]],null],[1,"\\n"]],[1,2]],null],[1,"    "],[13],[1,"\\n  "],[13],[1,"\\n\\n  "],[10,0],[14,0,"poll-breakdown-body"],[12],[1,"\\n    "],[10,0],[14,0,"poll-breakdown-body-header"],[12],[1,"\\n      "],[10,"label"],[14,0,"poll-breakdown-body-header-label"],[12],[1,[28,[35,1],["poll.breakdown.breakdown"],null]],[13],[1,"\\n\\n      "],[8,[39,7],null,[["@content","@value","@nameProperty","@class","@onChange"],[[30,0,["groupableUserFields"]],[30,0,["groupedBy"]],"label","poll-breakdown-dropdown",[28,[37,8],[[30,0],[30,0,["setGrouping"]]],null]]],null],[1,"\\n    "],[13],[1,"\\n\\n    "],[10,0],[14,0,"poll-breakdown-charts"],[12],[1,"\\n"],[42,[28,[37,3],[[28,[37,3],[[30,0,["charts"]]],null]],null],null,[[[1,"        "],[8,[39,9],null,[["@group","@options","@displayMode","@highlightedOption","@setHighlightedOption"],[[28,[37,10],[[30,3],"group"],null],[28,[37,10],[[30,3],"options"],null],[30,0,["displayMode"]],[30,0,["highlightedOption"]],[28,[37,5],[[28,[37,6],[[30,0,["highlightedOption"]]],null]],null]]],null],[1,"\\n"]],[3]],null],[1,"    "],[13],[1,"\\n  "],[13],[1,"\\n"]],[]]]]],[1,"\\n"]],["option","index","chart"],false,["d-modal-body","i18n","each","-track-array","poll-breakdown-option","fn","mut","combo-box","action","poll-breakdown-chart","get"]]',moduleName:"javascripts/discourse/templates/modal/poll-breakdown",isStrictMode:!1}),Ember.TEMPLATES["javascripts/modal/poll-ui-builder"]=Ember.HTMLBars.template({id:null,block:'[[[8,[39,0],null,[["@title","@class"],["poll.ui_builder.title","poll-ui-builder"]],[["default"],[[[[1,"\\n  "],[10,0],[14,0,"input-group poll-type"],[12],[1,"\\n    "],[11,3],[24,6,""],[16,0,[29,["poll-type-value ",[52,[30,0,["isRegular"]],"active"]]]],[4,[38,2],[[30,0],[28,[37,3],[[30,0,["pollType"]]],null],"regular"],null],[12],[1,"\\n      "],[1,[28,[35,4],["poll.ui_builder.poll_type.regular"],null]],[1,"\\n    "],[13],[1,"\\n\\n    "],[11,3],[24,6,""],[16,0,[29,["poll-type-value ",[52,[30,0,["isMultiple"]],"active"]]]],[4,[38,2],[[30,0],[28,[37,3],[[30,0,["pollType"]]],null],"multiple"],null],[12],[1,"\\n      "],[1,[28,[35,4],["poll.ui_builder.poll_type.multiple"],null]],[1,"\\n    "],[13],[1,"\\n\\n"],[41,[30,0,["showNumber"]],[[[1,"      "],[11,3],[24,6,""],[16,0,[29,["poll-type-value ",[52,[30,0,["isNumber"]],"active"]]]],[4,[38,2],[[30,0],[28,[37,3],[[30,0,["pollType"]]],null],"number"],null],[12],[1,"\\n        "],[1,[28,[35,4],["poll.ui_builder.poll_type.number"],null]],[1,"\\n      "],[13],[1,"\\n"]],[]],null],[1,"  "],[13],[1,"\\n\\n"],[41,[30,0,["showAdvanced"]],[[[1,"    "],[10,0],[14,0,"input-group poll-title"],[12],[1,"\\n      "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,4],["poll.ui_builder.poll_title.label"],null]],[13],[1,"\\n      "],[8,[39,5],null,[["@value"],[[30,0,["pollTitle"]]]],null],[1,"\\n    "],[13],[1,"\\n"]],[]],null],[1,"\\n"],[41,[51,[30,0,["isNumber"]]],[[[1,"    "],[10,0],[14,0,"poll-options"],[12],[1,"\\n"],[41,[30,0,["showAdvanced"]],[[[1,"        "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,4],["poll.ui_builder.poll_options.label"],null]],[13],[1,"\\n        "],[8,[39,7],[[4,[38,8],["input",[28,[37,2],[[30,0],"onOptionsTextChange"],null]],null]],[["@value"],[[30,0,["pollOptionsText"]]]],null],[1,""],[41,[30,0,["showMinNumOfOptionsValidation"]],[[[41,[51,[30,0,["minNumOfOptionsValidation","ok"]]],[[[1,"            "],[8,[39,9],null,[["@validation"],[[30,0,["minNumOfOptionsValidation"]]]],null],[1,"\\n"]],[]],null]],[]],null]],[]],[[[42,[28,[37,11],[[28,[37,11],[[30,0,["pollOptions"]]],null]],null],null,[[[1,"          "],[10,0],[14,0,"input-group poll-option-value"],[12],[1,"\\n            "],[8,[39,5],null,[["@value","@enter"],[[30,1,["value"]],[28,[37,2],[[30,0],"addOption",[30,1]],null]]],null],[1,"\\n"],[41,[30,0,["canRemoveOption"]],[[[1,"              "],[8,[39,12],null,[["@icon","@action"],["trash-alt",[28,[37,2],[[30,0],"removeOption",[30,1]],null]]],null],[1,"\\n"]],[]],null],[1,"          "],[13],[1,"\\n"]],[1]],null],[1,"\\n        "],[10,0],[14,0,"poll-option-controls"],[12],[1,"\\n          "],[8,[39,12],null,[["@class","@icon","@label","@action"],["btn-default","plus","poll.ui_builder.poll_options.add",[28,[37,2],[[30,0],"addOption",[30,0,["pollOptions","lastObject"]]],null]]],null],[1,"\\n"],[41,[28,[37,13],[[30,0,["showMinNumOfOptionsValidation"]],[28,[37,14],[[30,0,["minNumOfOptionsValidation","ok"]]],null]],null],[[[1,"            "],[8,[39,9],null,[["@validation"],[[30,0,["minNumOfOptionsValidation"]]]],null],[1,"\\n"]],[]],null],[1,"        "],[13],[1,"\\n"]],[]]],[1,"    "],[13],[1,"\\n"]],[]],null],[1,"\\n"],[41,[51,[30,0,["isRegular"]]],[[[1,"    "],[10,0],[14,0,"options"],[12],[1,"\\n      "],[10,0],[14,0,"input-group poll-number"],[12],[1,"\\n        "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,4],["poll.ui_builder.poll_config.min"],null]],[13],[1,"\\n        "],[8,[39,5],[[24,0,"poll-options-min"],[24,"min","1"]],[["@type","@value"],["number",[30,0,["pollMin"]]]],null],[1,"\\n      "],[13],[1,"\\n\\n      "],[10,0],[14,0,"input-group poll-number"],[12],[1,"\\n        "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,4],["poll.ui_builder.poll_config.max"],null]],[13],[1,"\\n        "],[8,[39,5],[[24,0,"poll-options-max"],[24,"min","1"]],[["@type","@value"],["number",[30,0,["pollMax"]]]],null],[1,"\\n      "],[13],[1,"\\n\\n"],[41,[30,0,["isNumber"]],[[[1,"        "],[10,0],[14,0,"input-group poll-number"],[12],[1,"\\n          "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,4],["poll.ui_builder.poll_config.step"],null]],[13],[1,"\\n          "],[8,[39,5],[[24,"min","1"],[24,0,"poll-options-step"]],[["@type","@value"],["number",[30,0,["pollStep"]]]],null],[1,"\\n        "],[13],[1,"\\n"]],[]],null],[1,"    "],[13],[1,"\\n\\n"],[41,[51,[30,0,["minMaxValueValidation","ok"]]],[[[1,"      "],[8,[39,9],null,[["@validation"],[[30,0,["minMaxValueValidation"]]]],null],[1,"\\n"]],[]],null]],[]],null],[1,"\\n"],[41,[30,0,["showAdvanced"]],[[[1,"    "],[10,0],[14,0,"input-group poll-allowed-groups"],[12],[1,"\\n      "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,4],["poll.ui_builder.poll_groups.label"],null]],[13],[1,"\\n      "],[8,[39,15],null,[["@content","@value","@onChange","@labelProperty","@valueProperty"],[[30,0,["siteGroups"]],[30,0,["pollGroups"]],[28,[37,2],[[30,0],[28,[37,3],[[30,0,["pollGroups"]]],null]],null],"name","name"]],null],[1,"\\n    "],[13],[1,"\\n\\n    "],[10,0],[14,0,"input-group poll-date"],[12],[1,"\\n      "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,4],["poll.ui_builder.automatic_close.label"],null]],[13],[1,"\\n      "],[8,[39,16],null,[["@date","@onChange","@clearable","@useGlobalPickerContainer"],[[30,0,["pollAutoClose"]],[28,[37,2],[[30,0],[28,[37,3],[[30,0,["pollAutoClose"]]],null]],null],true,true]],null],[1,"\\n    "],[13],[1,"\\n\\n    "],[10,0],[14,0,"input-group poll-select"],[12],[1,"\\n      "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,4],["poll.ui_builder.poll_result.label"],null]],[13],[1,"\\n      "],[8,[39,17],null,[["@content","@value","@class","@valueProperty","@onChange"],[[30,0,["pollResults"]],[30,0,["pollResult"]],"poll-result","value",[28,[37,2],[[30,0],[28,[37,3],[[30,0,["pollResult"]]],null]],null]]],null],[1,"\\n    "],[13],[1,"\\n\\n"],[41,[51,[30,0,["isNumber"]]],[[[1,"      "],[10,0],[14,0,"input-group poll-select column"],[12],[1,"\\n        "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,4],["poll.ui_builder.poll_chart_type.label"],null]],[13],[1,"\\n\\n        "],[10,0],[14,0,"radio-group"],[12],[1,"\\n          "],[8,[39,18],null,[["@id","@name","@value","@selection"],["poll-chart-type-bar","poll-chart-type","bar",[30,0,["chartType"]]]],null],[1,"\\n          "],[10,"label"],[14,"for","poll-chart-type-bar"],[12],[1,[28,[35,19],["chart-bar"],null]],[1," "],[1,[28,[35,4],["poll.ui_builder.poll_chart_type.bar"],null]],[13],[1,"\\n        "],[13],[1,"\\n\\n        "],[10,0],[14,0,"radio-group"],[12],[1,"\\n          "],[8,[39,18],null,[["@id","@name","@value","@selection"],["poll-chart-type-pie","poll-chart-type","pie",[30,0,["chartType"]]]],null],[1,"\\n          "],[10,"label"],[14,"for","poll-chart-type-pie"],[12],[1,[28,[35,19],["chart-pie"],null]],[1," "],[1,[28,[35,4],["poll.ui_builder.poll_chart_type.pie"],null]],[13],[1,"\\n        "],[13],[1,"\\n      "],[13],[1,"\\n"]],[]],null],[1,"\\n"],[41,[51,[30,0,["isPie"]]],[[[1,"      "],[10,0],[14,0,"input-group poll-checkbox column"],[12],[1,"\\n        "],[10,"label"],[12],[1,"\\n          "],[8,[39,5],null,[["@type","@checked"],["checkbox",[30,0,["publicPoll"]]]],null],[1,"\\n          "],[1,[28,[35,4],["poll.ui_builder.poll_public.label"],null]],[1,"\\n        "],[13],[1,"\\n      "],[13],[1,"\\n"]],[]],null]],[]],null]],[]]]]],[1,"\\n\\n"],[10,0],[14,0,"modal-footer"],[12],[1,"\\n  "],[8,[39,12],null,[["@action","@icon","@class","@label","@disabled"],[[28,[37,2],[[30,0],"insertPoll"],null],"chart-bar","btn-primary","poll.ui_builder.insert",[30,0,["disableInsert"]]]],null],[1,"\\n\\n  "],[8,[39,12],null,[["@label","@class","@action"],["cancel","btn-flat",[28,[37,20],["closeModal"],null]]],null],[1,"\\n\\n  "],[8,[39,12],null,[["@action","@class","@icon","@title"],[[28,[37,2],[[30,0],"toggleAdvanced"],null],"btn-default show-advanced","cog",[52,[30,0,["showAdvanced"]],"poll.ui_builder.hide_advanced","poll.ui_builder.show_advanced"]]],null],[1,"\\n"],[13],[1,"\\n"]],["option"],false,["d-modal-body","if","action","mut","i18n","input","unless","textarea","on","input-tip","each","-track-array","d-button","and","not","group-chooser","date-time-input","combo-box","radio-button","d-icon","route-action"]]',moduleName:"javascripts/discourse/templates/modal/poll-ui-builder",isStrictMode:!1}),define("discourse/plugins/poll/initializers/add-poll-ui-builder",["exports","discourse-common/utils/decorators","discourse/lib/show-modal","discourse/lib/plugin-api"],(function(t,e,l,o){"use strict";function n(t){var o,n,i,r,a,s,u,p;t.modifyClass("controller:composer",(o=(0,e.default)("siteSettings.poll_enabled","siteSettings.poll_minimum_trust_level_to_create","model.topic.pm_with_non_human_user"),i=n={pluginId:"discourse-poll-ui-builder",canBuildPoll:function(t,e,l){return t&&(l||this.currentUser&&(this.currentUser.staff||this.currentUser.trust_level>=e))},actions:{showPollBuilder:function(){(0,l.default)("poll-ui-builder").set("toolbarEvent",this.toolbarEvent)}}},r="canBuildPoll",a=[o],s=Object.getOwnPropertyDescriptor(n,"canBuildPoll"),u=n,p={},Object.keys(s).forEach((function(t){p[t]=s[t]})),p.enumerable=!!p.enumerable,p.configurable=!!p.configurable,("value"in p||p.initializer)&&(p.writable=!0),p=a.slice().reverse().reduce((function(t,e){return e(i,r,t)||t}),p),u&&void 0!==p.initializer&&(p.value=p.initializer?p.initializer.call(u):void 0,p.initializer=void 0),void 0===p.initializer&&(Object.defineProperty(i,r,p),p=null),n)),t.addToolbarPopupMenuOptionsCallback((function(){return{action:"showPollBuilder",icon:"chart-bar",label:"poll.ui_builder.title",condition:"canBuildPoll"}}))}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i={name:"add-poll-ui-builder",initialize:function(){(0,o.withPluginApi)("0.8.7",n)}};t.default=i})),define("discourse/plugins/poll/initializers/extend-for-poll",["exports","@ember/object","discourse/widgets/glue","discourse-common/lib/get-owner","discourse-common/utils/decorators","discourse/lib/plugin-api"],(function(t,e,l,o,n,i){"use strict";function r(t){return function(t){if(Array.isArray(t))return a(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return a(t,e);var l=Object.prototype.toString.call(t).slice(8,-1);"Object"===l&&t.constructor&&(l=t.constructor.name);if("Map"===l||"Set"===l)return Array.from(t);if("Arguments"===l||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l))return a(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(t,e){(null==e||e>t.length)&&(e=t.length);for(var l=0,o=new Array(e);l<e;l++)o[l]=t[l];return o}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s="discourse-poll",u=[],p=null;function c(){u.forEach((function(t){return t.queueRerender()}))}function d(){p&&(clearInterval(p),p=null),u.forEach((function(t){return t.cleanUp()})),u=[]}function h(t){var i,a,h,f,b,m,v,g,_=(0,o.getRegister)(t),y=t.container.lookup("site-settings:main").poll_groupable_user_fields;d(),t.modifyClass("controller:topic",{pluginId:s,subscribe:function(){var t=this;this._super.apply(this,arguments),this.messageBus.subscribe("/polls/"+this.get("model.id"),(function(e){var l=t.get("model.postStream").findLoadedPost(e.post_id);l&&l.set("polls",e.polls)}))},unsubscribe:function(){this.messageBus.unsubscribe("/polls/*"),this._super.apply(this,arguments)}}),t.modifyClass("model:post",(i=(0,n.observes)("polls"),h=a={pluginId:s,_polls:null,pollsObject:null,pollsChanged:function(){var t=this,l=this.polls;l&&(this._polls=this._polls||{},l.forEach((function(l){t._polls[l.name]?t._polls[l.name].setProperties(l):t._polls[l.name]=e.default.create(l)})),this.set("pollsObject",this._polls),c())}},f="pollsChanged",b=[i],m=Object.getOwnPropertyDescriptor(a,"pollsChanged"),v=a,g={},Object.keys(m).forEach((function(t){g[t]=m[t]})),g.enumerable=!!g.enumerable,g.configurable=!!g.configurable,("value"in g||g.initializer)&&(g.writable=!0),g=b.slice().reverse().reduce((function(t,e){return e(h,f,t)||t}),g),v&&void 0!==g.initializer&&(g.value=g.initializer?g.initializer.call(v):void 0,g.initializer=void 0),void 0===g.initializer&&(Object.defineProperty(h,f,g),g=null),a)),t.includePostAttributes("polls","polls_votes"),t.decorateCookedElement((function(o,n){var i=r(o.querySelectorAll(".poll"));if((i=i.filter((function(t){return"BLOCKQUOTE"!==t.parentNode.tagName}))).length&&n){var a=n.getModel();t.preventCloak(a.id),a.pollsChanged();var s=a.pollsObject||{},d=a.polls_votes||{};p=p||setInterval(c,3e4),i.forEach((function(t){var o,n=t.dataset.pollName,i=s[n],r=a,p=d[n]||[],c=null===(o=t.closest(".expanded-quote"))||void 0===o?void 0:o.dataset.postId;if(c&&a.quoted[c]&&(r=a.quoted[c],r=e.default.create(r),i=e.default.create(r.polls.findBy("name",n)),p=(p=r.polls_votes||{})[n]||[]),i){var h=t.querySelector(".poll-title"),f={id:"".concat(n,"-").concat(r.id),post:r,poll:i,vote:p,hasSavedVote:p.length>0,titleHTML:null==h?void 0:h.outerHTML,groupableUserFields:(y||"").split("|").filter(Boolean)},b=new l.default("discourse-poll",_,f);b.appendTo(t),u.push(b)}}))}}),{onlyStream:!0,id:"discourse-poll"}),t.cleanupStream(d)}var f={name:"extend-for-poll",initialize:function(){(0,i.withPluginApi)("0.8.7",h)}};t.default=f})),define("discourse/plugins/poll/lib/chart-colors",["exports"],(function(t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getColors=function(t,e){var l;switch(e=e||"cool"){case"cool":l={0:[255,255,255],25:[220,237,200],50:[66,179,213],75:[26,39,62],100:[0,0,0]};break;case"warm":l={0:[255,255,255],25:[254,235,101],50:[228,82,27],75:[77,52,47],100:[0,0,0]}}for(var o,n,i=Object.keys(l),r=[],a=0;a<t;a++){o=(a+1)*(100/(t+1));for(var s=void 0,u=n=n||0;u<i.length;u++){if(!i[u+1]){s=u-1;break}if(o>=i[u]&&o<i[u+1]){s=u;break}}for(var p=(o-i[s])/(i[s+1]-i[s]),c=[],d=0;d<3;d++)c.push(Math.round(l[i[s]][d]-(l[i[s]][d]-l[i[s+1]][d])*p));r.push("rgb(".concat(c.toString(),")")),n=s}return r}})),define("discourse/plugins/poll/lib/discourse-markdown/poll",["exports","I18n"],(function(t,e){"use strict";function l(t){return function(t){if(Array.isArray(t))return o(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return o(t,e);var l=Object.prototype.toString.call(t).slice(8,-1);"Object"===l&&t.constructor&&(l=t.constructor.name);if("Map"===l||"Set"===l)return Array.from(t);if("Arguments"===l||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l))return o(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var l=0,o=new Array(e);l<e;l++)o[l]=t[l];return o}Object.defineProperty(t,"__esModule",{value:!0}),t.setup=function(t){t.allowList(["div.poll","div.poll-info","div.poll-container","div.poll-title","div.poll-buttons","div[data-*]","span.info-number","span.info-text","span.info-label","a.button.cast-votes","a.button.toggle-results","li[data-*]"]),function(t){t.registerOptions((function(t,e){e.poll_enabled||(t.features.poll=!1),t.pollMaximumOptions=e.poll_maximum_options})),t.registerPlugin((function(t){t.block.bbcode.ruler.push("poll",a)}))}(t)}
/*!
   * Joseph Myer's md5() algorithm wrapped in a self-invoked function to prevent
   * global namespace pollution, modified to hash unicode characters as UTF-8.
   *
   * Copyright 1999-2010, Joseph Myers, Paul Johnston, Greg Holt, Will Bond <will@wbond.net>
   * http://www.myersdaily.org/joseph/javascript/md5-text.html
   * http://pajhome.org.uk/crypt/md5
   *
   * Released under the BSD license
   * http://www.opensource.org/licenses/bsd-license
   */;var n="data-poll-",i=["close","max","min","name","order","public","results","chartType","groups","status","step","type"];function r(t,e){t.push("text","",0).content="[/"+e+"]"}var a={tag:"poll",before:function(t,e,l){var o=t.push("text","",0);o.content=l,o.bbcode_attrs=e.attrs,o.bbcode_type="poll_open"},after:function(t,o,a){var u=function(t,e){var l=t.indexOf(e);if(-1!==l){var o=t.slice(l),n=o.findIndex((function(t){return"heading_open"===t.type})),i=o.findIndex((function(t){return"heading_close"===t.type}));if(-1!==n&&-1!==i){var r=o.slice(n+1,i);return t.splice(l+n,i-n+1),r}}}(t.tokens,o),p=function(t,e){for(var l=t.length-1,o=[],n=[];t[l]!==e;l--){if(0===l)return;var i=t[l];if(0===i.level&&"ol"!==i.tag&&"ul"!==i.tag)return;if(1===i.level&&1===i.nesting){if("li"!==i.tag)return;o.push([i,n.reverse().join(" ")])}1===i.level&&1===i.nesting&&"li"===i.tag?n=[]:"text"!==i.type&&"inline"!==i.type||n.push(i.content)}return o.reverse()}(t.tokens,o);if(!p)return r(t,a);var c=o.bbcode_attrs,d=[["class","poll"]];c.status||d.push(["data-poll-status","open"]),i.forEach((function(t){c[t]&&d.push([n+t,c[t]])})),c.name||d.push(["data-poll-name","poll"]);var h=parseInt(c.min,10),b=parseInt(c.max,10),v=parseInt(c.step,10);v<1&&(v=1);var g=[],_=new t.Token("poll_open","div",1);if(_.block=!0,_.attrs=d,g.push(_),(_=new t.Token("poll_open","div",1)).block=!0,g.push(_),(_=new t.Token("poll_open","div",1)).attrs=[["class","poll-container"]],g.push(_),u&&((_=new t.Token("title_open","div",1)).attrs=[["class","poll-title"]],g.push(_),g.push.apply(g,l(u)),_=new t.Token("title_close","div",-1),g.push(_)),"number"===c.type){if(isNaN(h)&&(h=1),isNaN(b)&&(b=t.md.options.discourse.pollMaximumOptions),isNaN(v)&&(v=1),p.length>0)return r(t,a);_=new t.Token("bullet_list_open","ul",1),g.push(_);for(var y=h;y<=b;y+=v)_=new t.Token("list_item_open","li",1),p.push([_,String(y)]),g.push(_),(_=new t.Token("text","",0)).content=String(y),g.push(_),_=new t.Token("list_item_close","li",-1),g.push(_);_=new t.Token("bullet_item_close","",-1),g.push(_)}for(var O=0;O<p.length;O++){_=p[O][0];var w=p[O][1];_.attrs=_.attrs||[];var x=function(t){for(var e=0;e<t.length;e++)t[e]=m(t[e]);return t.join("")}(function(t){var e,l=(t=unescape(encodeURI(t))).length,o=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=t.length;e+=64)s(o,f(t.substring(e-64,e)));t=t.substring(e-64);var n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<t.length;e++)n[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(s(o,n),e=0;e<16;e++)n[e]=0;return n[14]=8*l,s(o,n),o}(JSON.stringify([w])));_.attrs.push(["data-poll-option-id",x])}!function(t,e,o){var n=t.indexOf(e),i=t[n].level;for(t.splice.apply(t,[n,1].concat(l(o))),o[0].map=e.map;n<t.length;n++){var r=t[n].nesting;r<0&&i--,t[n].level=i,r>0&&i++}}(t.tokens,o,g),t.level=t.tokens[t.tokens.length-1].level,t.push("poll_close","div",-1),(_=t.push("poll_open","div",1)).attrs=[["class","poll-info"]],t.push("paragraph_open","p",1),(_=t.push("span_open","span",1)).block=!1,_.attrs=[["class","info-number"]],(_=t.push("text","",0)).content="0",t.push("span_close","span",-1),(_=t.push("span_open","span",1)).block=!1,_.attrs=[["class","info-label"]],(_=t.push("text","",0)).content=e.default.t("poll.voters",{count:0}),t.push("span_close","span",-1),t.push("paragraph_close","p",-1),t.push("poll_close","div",-1),t.push("poll_close","div",-1),t.push("poll_close","div",-1)}};function s(t,e){var l=t[0],o=t[1],n=t[2],i=t[3];l=p(l,o,n,i,e[0],7,-680876936),i=p(i,l,o,n,e[1],12,-389564586),n=p(n,i,l,o,e[2],17,606105819),o=p(o,n,i,l,e[3],22,-1044525330),l=p(l,o,n,i,e[4],7,-176418897),i=p(i,l,o,n,e[5],12,1200080426),n=p(n,i,l,o,e[6],17,-1473231341),o=p(o,n,i,l,e[7],22,-45705983),l=p(l,o,n,i,e[8],7,1770035416),i=p(i,l,o,n,e[9],12,-1958414417),n=p(n,i,l,o,e[10],17,-42063),o=p(o,n,i,l,e[11],22,-1990404162),l=p(l,o,n,i,e[12],7,1804603682),i=p(i,l,o,n,e[13],12,-40341101),n=p(n,i,l,o,e[14],17,-1502002290),l=c(l,o=p(o,n,i,l,e[15],22,1236535329),n,i,e[1],5,-165796510),i=c(i,l,o,n,e[6],9,-1069501632),n=c(n,i,l,o,e[11],14,643717713),o=c(o,n,i,l,e[0],20,-373897302),l=c(l,o,n,i,e[5],5,-701558691),i=c(i,l,o,n,e[10],9,38016083),n=c(n,i,l,o,e[15],14,-660478335),o=c(o,n,i,l,e[4],20,-405537848),l=c(l,o,n,i,e[9],5,568446438),i=c(i,l,o,n,e[14],9,-1019803690),n=c(n,i,l,o,e[3],14,-187363961),o=c(o,n,i,l,e[8],20,1163531501),l=c(l,o,n,i,e[13],5,-1444681467),i=c(i,l,o,n,e[2],9,-51403784),n=c(n,i,l,o,e[7],14,1735328473),l=d(l,o=c(o,n,i,l,e[12],20,-1926607734),n,i,e[5],4,-378558),i=d(i,l,o,n,e[8],11,-2022574463),n=d(n,i,l,o,e[11],16,1839030562),o=d(o,n,i,l,e[14],23,-35309556),l=d(l,o,n,i,e[1],4,-1530992060),i=d(i,l,o,n,e[4],11,1272893353),n=d(n,i,l,o,e[7],16,-155497632),o=d(o,n,i,l,e[10],23,-1094730640),l=d(l,o,n,i,e[13],4,681279174),i=d(i,l,o,n,e[0],11,-358537222),n=d(n,i,l,o,e[3],16,-722521979),o=d(o,n,i,l,e[6],23,76029189),l=d(l,o,n,i,e[9],4,-640364487),i=d(i,l,o,n,e[12],11,-421815835),n=d(n,i,l,o,e[15],16,530742520),l=h(l,o=d(o,n,i,l,e[2],23,-995338651),n,i,e[0],6,-198630844),i=h(i,l,o,n,e[7],10,1126891415),n=h(n,i,l,o,e[14],15,-1416354905),o=h(o,n,i,l,e[5],21,-57434055),l=h(l,o,n,i,e[12],6,1700485571),i=h(i,l,o,n,e[3],10,-1894986606),n=h(n,i,l,o,e[10],15,-1051523),o=h(o,n,i,l,e[1],21,-2054922799),l=h(l,o,n,i,e[8],6,1873313359),i=h(i,l,o,n,e[15],10,-30611744),n=h(n,i,l,o,e[6],15,-1560198380),o=h(o,n,i,l,e[13],21,1309151649),l=h(l,o,n,i,e[4],6,-145523070),i=h(i,l,o,n,e[11],10,-1120210379),n=h(n,i,l,o,e[2],15,718787259),o=h(o,n,i,l,e[9],21,-343485551),t[0]=v(l,t[0]),t[1]=v(o,t[1]),t[2]=v(n,t[2]),t[3]=v(i,t[3])}function u(t,e,l,o,n,i){return e=v(v(e,t),v(o,i)),v(e<<n|e>>>32-n,l)}function p(t,e,l,o,n,i,r){return u(e&l|~e&o,t,e,n,i,r)}function c(t,e,l,o,n,i,r){return u(e&o|l&~o,t,e,n,i,r)}function d(t,e,l,o,n,i,r){return u(e^l^o,t,e,n,i,r)}function h(t,e,l,o,n,i,r){return u(l^(e|~o),t,e,n,i,r)}function f(t){var e,l=[];for(e=0;e<64;e+=4)l[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return l}var b="0123456789abcdef".split("");function m(t){for(var e="",l=0;l<4;l++)e+=b[t>>8*l+4&15]+b[t>>8*l&15];return e}function v(t,e){return t+e&4294967295}})),define("discourse/plugins/poll/lib/even-round",["exports"],(function(t){"use strict";function e(t){return 100===t.map((function(t){return Math.floor(t)})).reduce((function(t,e){return t+e}))}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(t){for(var l=t.map((function(t){return t%1})),o=Math.ceil(l.reduce((function(t,e){return t+e}))),n=0,i=l.length;n<o&&n<i;n++){for(var r=0,a=0,s=0;s<l.length;s++)l[s]>r&&(a=s,r=l[s]);if(++t[a],l[a]=0,e(t))break}return t.map((function(t){return Math.floor(t)}))}})),define("discourse/plugins/poll/widgets/discourse-poll",["exports","I18n","discourse/plugins/poll/controllers/poll-ui-builder","discourse/widgets/raw-html","discourse/lib/ajax","discourse/widgets/post","discourse/widgets/widget","discourse/plugins/poll/lib/even-round","discourse/plugins/poll/lib/chart-colors","virtual-dom","discourse-common/lib/icon-library","discourse/lib/load-script","discourse/lib/ajax-error","discourse/lib/formatter","discourse/lib/round","discourse/lib/show-modal","bootbox","discourse/lib/local-dates"],(function(t,e,l,o,n,i,r,a,s,u,p,c,d,h,f,b,m,v){"use strict";function g(t){return function(t){if(Array.isArray(t))return _(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return _(t,e);var l=Object.prototype.toString.call(t).slice(8,-1);"Object"===l&&t.constructor&&(l=t.constructor.name);if("Map"===l||"Set"===l)return Array.from(t);if("Arguments"===l||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l))return _(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _(t,e){(null==e||e>t.length)&&(e=t.length);for(var l=0,o=new Array(e);l<e;l++)o[l]=t[l];return o}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;function y(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=document.createElement("span");return l.innerHTML=t.html,(0,v.applyLocalDates)(l.querySelectorAll(".discourse-local-date"),e),new o.default({html:"<span>".concat(l.innerHTML,"</span>")})}function O(t){return new o.default({html:'<span class="info-text">'.concat(t,"</span>")})}function w(t,e){var l=e&&e.groups&&e.groups.split(",").map((function(t){return t.toLowerCase()}));if(!l)return!0;var o=t&&t.groups&&t.groups.map((function(t){return t.name.toLowerCase()}));return o&&l.some((function(t){return o.includes(t)}))}(0,r.createWidget)("discourse-poll-option",{tagName:"li",buildAttributes:function(t){return{tabindex:0,"data-poll-option-id":t.option.id}},html:function(t){var e=[],l=t.option,o=t.vote.includes(l.id);return t.isMultiple?e.push((0,p.iconNode)(o?"far-check-square":"far-square")):e.push((0,p.iconNode)(o?"circle":"far-circle")),e.push(" "),e.push(y(l,this.siteSettings)),e},click:function(t){t.target.closest("a")||this.sendWidgetAction("toggleOption",this.attrs.option)},keyDown:function(t){"Enter"===t.key&&this.click(t)}}),(0,r.createWidget)("discourse-poll-load-more",{tagName:"div.poll-voters-toggle-expand",buildKey:function(t){return"load-more-".concat(t.optionId)},defaultState:function(){return{loading:!1}},html:function(t,e){return e.loading?(0,u.h)("div.spinner.small"):(0,u.h)("a",(0,p.iconNode)("chevron-down"))},click:function(){var t=this.state,e=this.attrs;if(!t.loading)return t.loading=!0,this.sendWidgetAction("fetchVoters",e.optionId).finally((function(){return t.loading=!1}))}}),(0,r.createWidget)("discourse-poll-voters",{tagName:"ul.poll-voters-list",buildKey:function(t){return"poll-voters-".concat(t.optionId)},html:function(t){var e=t.voters.map((function(t){return(0,u.h)("li",[(0,i.avatarFor)("tiny",{username:t.username,template:t.avatar_template})," "])}));return t.voters.length<t.totalVotes&&e.push(this.attach("discourse-poll-load-more",t)),(0,u.h)("div.poll-voters",e)}}),(0,r.createWidget)("discourse-poll-standard-results",{tagName:"ul.results",buildKey:function(t){return"poll-standard-results-".concat(t.id)},html:function(t){var e=this,l=t.poll,o=l.options;if(o){var n=l.voters,i=l.public,r=g(o).sort((function(t,e){return t.votes<e.votes?1:t.votes===e.votes?t.html<e.html?-1:1:-1})),s=0===n?Array(r.length).fill(0):r.map((function(t){return 100*t.votes/n})),p=t.isMultiple?s.map(Math.floor):(0,a.default)(s);return r.map((function(o,n){var r=[],a=p[n].toString(),s=(t.vote||[]).includes(o.id);return r.push((0,u.h)("div.option",(0,u.h)("p",[(0,u.h)("span.percentage","".concat(a,"%")),y(o,e.siteSettings)]))),r.push((0,u.h)("div.bar-back",(0,u.h)("div.bar",{attributes:{style:"width:".concat(a,"%")}}))),i&&r.push(e.attach("discourse-poll-voters",{postId:t.post.id,optionId:o.id,pollName:l.name,totalVotes:o.votes,voters:t.voters&&t.voters[o.id]||[]})),(0,u.h)("li",{className:"".concat(s?"chosen":"")},r)}))}}}),(0,r.createWidget)("discourse-poll-number-results",{buildKey:function(t){return"poll-number-results-".concat(t.id)},html:function(t){var l=t.poll,n=l.options.reduce((function(t,e){return t+parseInt(e.html,10)*parseInt(e.votes,10)}),0),i=l.voters,r=0===i?0:(0,f.default)(n/i,-2),a=e.default.t("poll.average_rating",{average:r}),s=[(0,u.h)("div.poll-results-number-rating",new o.default({html:"<span>".concat(a,"</span>")}))];return l.public&&s.push(this.attach("discourse-poll-voters",{totalVotes:l.voters,voters:t.voters||[],postId:t.post.id,pollName:l.name,pollType:l.type})),s}}),(0,r.createWidget)("discourse-poll-container",{tagName:"div.poll-container",buildKey:function(t){return"poll-container-".concat(t.id)},defaultState:function(){return{voters:[]}},html:function(t,n){var i=this,r=t.poll,a=r.options;if(t.showResults){var s=[];t.titleHTML&&s.push(new o.default({html:t.titleHTML})),r.public&&(n.voters=r.preloaded_voters);var p="number"===r.type?"number":"standard",c="number"===p||t.poll.chart_type!==l.PIE_CHART_TYPE?"discourse-poll-".concat(p,"-results"):"discourse-poll-pie-chart";return s.push(this.attach(c,Object.assign({},t,{voters:n.voters}))),s}if(a){var d=[];return t.titleHTML&&d.push(new o.default({html:t.titleHTML})),w(this.currentUser,r)||d.push((0,u.h)("div.alert.alert-danger",e.default.t("poll.results.groups.title",{groups:r.groups}))),d.push((0,u.h)("ul",a.map((function(e){return i.attach("discourse-poll-option",{option:e,isMultiple:t.isMultiple,vote:t.vote})})))),d}},fetchVoters:function(t){var l,o=this,i=this.attrs,r=this.state;return t?(r.voters||(r.voters={}),r.voters[t]||(r.voters[t]=[]),l=r.voters[t].length):(r.voters||(r.voters=[]),l=r.voters.length),(0,n.ajax)("/polls/voters.json",{data:{post_id:i.post.id,poll_name:i.poll.name,option_id:t,page:Math.floor(l/25)+1,limit:25}}).then((function(e){var l=t?r.voters[t]:r.voters,n=t?e.voters[t]:e.voters,a=new Set(l.map((function(t){return t.username})));n.forEach((function(t){a.has(t.username)||(a.add(t.username),l.push(t))})),"regular"===i.poll.type&&Object.keys(r.voters).forEach((function(e){t!==e&&(r.voters[e]=r.voters[e].filter((function(t){return!a.has(t.username)})))})),o.scheduleRerender()})).catch((function(t){t?(0,d.popupAjaxError)(t):m.default.alert(e.default.t("poll.error_while_fetching_voters"))}))}}),(0,r.createWidget)("discourse-poll-info",{tagName:"div.poll-info",multipleHelpText:function(t,l,o){if(l>0)if(t===l){if(t>1)return e.default.t("poll.multiple.help.x_options",{count:t})}else{if(t>1)return l<o?e.default.t("poll.multiple.help.between_min_and_max_options",{min:t,max:l}):e.default.t("poll.multiple.help.at_least_min_options",{count:t});if(l<=o)return e.default.t("poll.multiple.help.up_to_max_options",{count:l})}},html:function(t){var l=t.poll,o=l.voters,n=[(0,u.h)("p",[(0,u.h)("span.info-number",o.toString()),(0,u.h)("span.info-label",e.default.t("poll.voters",{count:o}))])];if(t.isMultiple)if(t.showResults||t.isClosed){var i=l.options.reduce((function(t,e){return t+parseInt(e.votes,10)}),0);n.push((0,u.h)("p",[(0,u.h)("span.info-number",i.toString()),(0,u.h)("span.info-label",e.default.t("poll.total_votes",{count:i}))]))}else{var r=this.multipleHelpText(t.min,t.max,l.options.length);r&&n.push(O(r))}return t.isClosed||t.showResults||!l.public||"staff_only"===l.results||n.push(O(e.default.t("poll.public.title"))),n}}),(0,r.createWidget)("discourse-poll-pie-canvas",{tagName:"canvas.poll-results-canvas",init:function(t){var e=this;(0,c.default)("/javascripts/Chart.min.js").then((function(){var o=function(t,e){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n="aspectRatio"in o?o.aspectRatio:2.2,i=e.map((function(t){return M(t)}));return{type:l.PIE_CHART_TYPE,data:{datasets:[{data:t,backgroundColor:(0,s.getColors)(t.length)}],labels:i},plugins:[x],options:{responsive:!0,aspectRatio:n,animation:{duration:0},plugins:{legend:{labels:{generateLabels:function(){return e.map((function(e,l){return{fillStyle:(0,s.getColors)(t.length)[l],text:e,index:l}}))}},display:!1},htmlLegend:{containerID:null==o?void 0:o.legendContainerId}}}}}(t.poll.options.mapBy("votes"),t.poll.options.mapBy("html"),{legendContainerId:"poll-results-legend-".concat(t.id)}),n=document.getElementById("poll-results-chart-".concat(t.id));e._chart=new Chart(n.getContext("2d"),o)}))},willRerenderWidget:function(){var t;null===(t=this._chart)||void 0===t||t.destroy()},buildAttributes:function(t){return{id:"poll-results-chart-".concat(t.id)}}}),(0,r.createWidget)("discourse-poll-pie-chart",{tagName:"div.poll-results-chart",html:function(t){var e,l,o=[];if(!t.showResults)return e=t.id,(l=document.querySelector("#poll-results-chart-".concat(e)))&&l.parentNode.removeChild(l),o;var n=this.attach("discourse-poll-pie-canvas",t);return o.push(n),o.push((0,u.h)("ul#poll-results-legend-".concat(t.id,".pie-chart-legends"))),o}});var x={id:"htmlLegend",afterUpdate:function(t,e,l){var o=document.getElementById(l.containerID);o.innerHTML="",t.options.plugins.legend.labels.generateLabels(t).forEach((function(e){var l=document.createElement("li");l.classList.add("legend"),l.onclick=function(){t.toggleDataVisibility(e.index),t.update()};var n=document.createElement("span");n.classList.add("swatch"),n.style.background=e.fillStyle;var i=document.createElement("span");i.style.color=e.fontColor,i.innerHTML=e.text,t.getDataVisibility(e.index)?l.style.opacity=1:l.style.opacity=.2,l.appendChild(n),l.appendChild(i),o.appendChild(l)}))}};function M(t){return(new DOMParser).parseFromString(t,"text/html").body.textContent||""}(0,r.createWidget)("discourse-poll-buttons",{tagName:"div.poll-buttons",html:function(t){var l,n,i=[],r=t.poll,a=t.post,s=a.get("topic.archived"),u=t.isClosed,p="staff_only"===r.results,c=this.currentUser&&this.currentUser.staff,d=this.currentUser&&this.currentUser.admin,f=this.currentUser&&a.user_id===this.currentUser.id,b=this.siteSettings.data_explorer_enabled,m=!p&&(u||s),v=this.siteSettings.poll_export_data_explorer_query_id;if(t.isMultiple&&!m){var g=!t.canCastVotes;i.push(this.attach("button",{className:"cast-votes ".concat(g?"btn-default":"btn-primary"),label:"poll.cast-votes.label",title:"poll.cast-votes.title",disabled:g,action:"castVotes"})),i.push(" ")}t.showResults||m?i.push(this.attach("button",{className:"btn-default toggle-results",label:"poll.hide-results.label",title:"poll.hide-results.title",icon:"far-eye-slash",disabled:m,action:"toggleResults"})):("on_vote"!==r.results||t.hasVoted||f?"on_close"!==r.results||u?"staff_only"!==r.results||c?l=this.attach("button",{className:"btn-default toggle-results",label:"poll.show-results.label",title:"poll.show-results.title",icon:"far-eye",disabled:0===r.voters,action:"toggleResults"}):n=O(e.default.t("poll.results.staff.title")):n=O(e.default.t("poll.results.closed.title")):n=O(e.default.t("poll.results.vote.title")),l&&i.push(l),t.hasSavedVote&&i.push(this.attach("button",{className:"btn-default remove-vote",label:"poll.remove-vote.label",title:"poll.remove-vote.title",icon:"trash-alt",action:"removeVote"})),n&&i.push(n));if(t.groupableUserFields.length&&r.voters>0){var _=this.attach("button",{className:"btn-default poll-show-breakdown",label:"poll.group-results.label",title:"poll.group-results.title",icon:"far-eye",action:"showBreakdown"});i.push(_)}if(d&&b&&r.voters>0&&v&&i.push(this.attach("button",{className:"btn btn-default export-results",label:"poll.export-results.label",title:"poll.export-results.title",icon:"download",disabled:0===r.voters,action:"exportResults"})),r.close){var y=moment(r.close);if(y.isValid()){var w,x=y.format("LLL");if(t.isAutomaticallyClosed){var M=(0,h.relativeAge)(y.toDate(),{addAgo:!0});w=e.default.t("poll.automatic_close.age",{age:M})}else{var P=moment().to(y,!0);w=e.default.t("poll.automatic_close.closes_in",{timeLeft:P})}i.push(new o.default({html:'<span class="info-text" title="'.concat(x,'">').concat(w,"</span>")}))}}return!this.currentUser||this.currentUser.id!==a.user_id&&!c||s||(u?t.isAutomaticallyClosed||i.push(this.attach("button",{className:"btn-default toggle-status",label:"poll.open.label",title:"poll.open.title",icon:"unlock-alt",action:"toggleStatus"})):i.push(this.attach("button",{className:"toggle-status btn-danger",label:"poll.close.label",title:"poll.close.title",icon:"lock",action:"toggleStatus"}))),i}});var P=(0,r.createWidget)("discourse-poll",{tagName:"div",buildKey:function(t){return"poll-".concat(t.id)},buildAttributes:function(t){var e="poll";return t.poll.chart_type===l.PIE_CHART_TYPE&&(e+=" pie"),{class:e,"data-poll-name":t.poll.name,"data-poll-type":t.poll.type}},defaultState:function(t){var e=t.poll,l="staff_only"===t.poll.results;return{loading:!1,showResults:"on_close"!==e.results&&this.hasVoted()&&!l}},html:function(t,e){var l="staff_only"===t.poll.results,o=e.showResults||t.post.get("topic.archived")&&!l||this.isClosed()&&!l,n=Object.assign({},t,{canCastVotes:this.canCastVotes(),hasVoted:this.hasVoted(),isAutomaticallyClosed:this.isAutomaticallyClosed(),isClosed:this.isClosed(),isMultiple:this.isMultiple(),max:this.max(),min:this.min(),showResults:o});return(0,u.h)("div",[this.attach("discourse-poll-container",n),this.attach("discourse-poll-info",n),this.attach("discourse-poll-buttons",n)])},min:function(){var t=parseInt(this.attrs.poll.min,10);return(isNaN(t)||t<0)&&(t=1),t},max:function(){var t=parseInt(this.attrs.poll.max,10),e=this.attrs.poll.options.length;return(isNaN(t)||t>e)&&(t=e),t},isAutomaticallyClosed:function(){var t=this.attrs.poll;return t.close&&moment.utc(t.close)<=moment()},isClosed:function(){return"closed"===this.attrs.poll.status||this.isAutomaticallyClosed()},isMultiple:function(){return"multiple"===this.attrs.poll.type},hasVoted:function(){var t=this.attrs.vote;return t&&t.length>0},canCastVotes:function(){var t=this.state,e=this.attrs;if(this.isClosed()||t.showResults||t.loading)return!1;var l=e.vote.length;return this.isMultiple()?l>=this.min()&&l<=this.max():l>0},toggleStatus:function(){var t=this,l=this.state,o=this.attrs,i=o.post,r=o.poll;this.isAutomaticallyClosed()||m.default.confirm(e.default.t(this.isClosed()?"poll.open.confirm":"poll.close.confirm"),e.default.t("no_value"),e.default.t("yes_value"),(function(o){if(o){l.loading=!0;var a=t.isClosed()?"open":"closed";(0,n.ajax)("/polls/toggle_status",{type:"PUT",data:{post_id:i.id,poll_name:r.name,status:a}}).then((function(){r.set("status",a),"on_close"===r.results&&(l.showResults="closed"===a),t.scheduleRerender()})).catch((function(t){t?(0,d.popupAjaxError)(t):m.default.alert(e.default.t("poll.error_while_toggling_status"))})).finally((function(){l.loading=!1}))}}))},toggleResults:function(){this.state.showResults=!this.state.showResults},removeVote:function(){var t=this,e=this.attrs,l=this.state;return l.loading=!0,(0,n.ajax)("/polls/vote",{type:"DELETE",data:{post_id:e.post.id,poll_name:e.poll.name}}).then((function(l){var o=l.poll;e.poll.setProperties(o),e.vote.length=0,e.hasSavedVote=!1,t.appEvents.trigger("poll:voted",o,e.post,e.vote)})).catch((function(t){return(0,d.popupAjaxError)(t)})).finally((function(){l.loading=!1}))},exportResults:function(){var t=this.attrs,l=this.siteSettings.poll_export_data_explorer_query_id;(0,n.ajax)("/admin/plugins/explorer/queries/".concat(l,"/run.csv"),{type:"POST",data:{params:JSON.stringify({poll_name:t.poll.name,post_id:t.post.id.toString()}),explain:!1,limit:1e6,download:1}}).then((function(e){var l=document.createElement("a"),o=new Blob([e],{type:"text/csv;charset=utf-8;"});l.href=URL.createObjectURL(o),l.setAttribute("download","poll-export-".concat(t.poll.name,"-").concat(t.post.id,".csv")),l.click(),l.remove()})).catch((function(t){t?(0,d.popupAjaxError)(t):m.default.alert(e.default.t("poll.error_while_exporting_results"))}))},showLogin:function(){this.register.lookup("route:application").send("showLogin")},_toggleOption:function(t){var e=this.attrs.vote,l=e.indexOf(t.id);-1!==l?e.splice(l,1):e.push(t.id)},toggleOption:function(t){var e=this,l=this.attrs;if(!this.isClosed()){if(!this.currentUser)return this.showLogin();if(w(this.currentUser,this.attrs.poll)){var o=l.vote;return this.isMultiple()||1!==o.length||o[0]!==t.id?(this.isMultiple()||(o.length=0),this._toggleOption(t),this.isMultiple()?void 0:this.castVotes().catch((function(){return e._toggleOption(t)}))):this.removeVote()}}},castVotes:function(){var t=this;if(this.canCastVotes()){if(!this.currentUser)return this.showLogin();var l=this.attrs,o=this.state;return o.loading=!0,(0,n.ajax)("/polls/vote",{type:"PUT",data:{post_id:l.post.id,poll_name:l.poll.name,options:l.vote}}).then((function(e){var n=e.poll;l.hasSavedVote=!0,l.poll.setProperties(n),t.appEvents.trigger("poll:voted",n,l.post,l.vote),"on_close"!==l.poll.results&&(o.showResults=!0),"staff_only"===l.poll.results&&(t.currentUser&&t.currentUser.staff?o.showResults=!0:o.showResults=!1)})).catch((function(t){t?(0,d.popupAjaxError)(t):m.default.alert(e.default.t("poll.error_while_casting_votes"))})).finally((function(){o.loading=!1}))}},showBreakdown:function(){(0,b.default)("poll-breakdown",{model:this.attrs,panels:[{id:"percentage",title:"poll.breakdown.percentage"},{id:"count",title:"poll.breakdown.count"}]})}});t.default=P}));
//# sourceMappingURL=poll-bc4217fd8ee1eee81c9d8463c38c46ad3461aacece1955a296348170f58da4bc.js.map